{"title":"Stencil Blog - Unit Testing StencilJS","date":"10. Mai 2020","url":"/blog/unit-testing-stenciljs","author":"Christian Binzer","twitter":"chbinzer","description":"Wie kann man mit Unit Tests die Logik und den HTML-Inhalt einer StencilJS Komponente testen? Antworten gibt es in diesem Blog Post.","img":"/assets/img/blog/posts/unit-testing-stenciljs/unit-testing-stenciljs.png","srcPath":"./src/blog/unit-testing-stenciljs.md","hypertext":["div",null,["p",null,["img",{"src":"/assets/img/blog/posts/unit-testing-stenciljs/unit-testing-stenciljs.png","alt":"Unit Testing StencilJS"}]],"\n",["p",null,"In meinem letzten Blog Post habe ich euch eine kurze ",["a",{"href":"/blog/einfuehrung-stenciljs","target":"_blank"},"Einführung in StencilJS"]," gegeben. Ich bin auf die Definition eingegangen, habe beschrieben wie ein neues Projekt aufgesetzt wird und habe euch am Beispiel eines Alerts gezeigt, wie Komponenten erstellt werden."],"\n",["p",null,"Dieses Mal möchte ich auf das Thema Unit Testing mit ",["a",{"href":"https://stenciljs.com/","target":"_blank"},"StencilJS"]," eingehen. Leider sieht man heutzutage immer noch in Projekten, dass das Thema Testing stiefmütterlich behandelt wird. Besonders im Bereich Front-End-Entwicklung. Man hört immer wieder Ausreden wie, \"Front-End-Tests sind zu kompliziert\" oder \"wir haben keine Zeit zum Testen\". Dabei haben nahezu alle Bibliotheken eine top Test-Unterstützung, die das Schreiben von Tests vereinfacht und beschleunigt."],"\n",["p",null,"Auch StencilJS bringt einen sehr guten Support fürs Testen mit, den ich euch in diesem Artikel vorstellen möchte."],"\n",["h2",{"id":"konfiguration"},"Konfiguration"],"\n",["p",null,"StencilJS verwendet ",["a",{"href":"https://jestjs.io/","target":"_blank"},"Jest"]," als Testing Lösung für Unit Tests. Jest ist ein von Facebook geschriebenes JavaScript Testing Framework und hat in den letzten Jahren viel an Popularität gewonnen. Es zeichnet sich durch die einfache Konfiguration, gute API sowie Schnelligkeit aus. Am meisten verbreitet ist es in der ",["a",{"href":"https://reactjs.org/","target":"_blank"},"React"],"-Welt, funktioniert aber mit jedem beliebigen JavaScript-Projekt."],"\n",["p",null,"StencilJS bringt eine eigene Jest-Konfiguration mit. Diese ist im Stencil-CLI enthalten. Damit wird einem die Konfiguration einer Test-Umgebung abgenommen, sodass direkt mit dem Testen losgelegt werden kann. Unit Tests werden in Dateien mit der Endung ",["code",null,".spec.ts"]," erstellt und können mit dem folgenden Kommando ausgeführt werden:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-bash"},["code",{"class":"language-bash"},"stencil ",["span",{"class":"token builtin class-name"},"test"]," --spec"]],"\n  "],"\n  ",["p",null,"Mit dem ",["code",null,"watchAll"],"-Flag kann man die Tests auch im Watch-Mode ausführen, der uns bei der testgetriebenen Entwicklung unterstützt:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-bash"},["code",{"class":"language-bash"},"stencil ",["span",{"class":"token builtin class-name"},"test"]," --spec --watchAll"]],"\n  "],"\n  ",["p",null,"Nicht wundern, der erste Start eines Tests kann etwas länger dauern, denn bei einem neu aufgesetzten Projekt sind die Testing-Dependencies noch nicht vorhanden. StencilJS installiert Jest sowie die zugehörigen Types erst bei Bedarf und fügt sie dann der ",["code",null,"package.json"]," hinzu."],"\n",["h2",{"id":"komponentenlogik-testen"},"Komponentenlogik testen"],"\n",["p",null,"Komponentenlogik lässt sich in StencilJS relativ einfach testen, denn eine StencilJS-Komponente ist nichts anderes als eine TypeScript-Klasse. Für einen einfachen Test kann man also die Klasse instanziieren, darauf folgend die passenden Methodenaufrufe durchführen und am Ende die erwartenden Änderungen am Objekt prüfen."],"\n",["p",null,"Nehmen wir an wir haben wieder eine simple Alert-Komponente (wie schon in meinem ",["a",{"href":"/blog/einfuehrung-stenciljs","target":"_blank"},"letzten Blog-Artikel"],"), die ein ",["code",null,"visible"],"-Attribut und eine Methode ",["code",null,"show"]," enthält. Der initiale Zustand des ",["code",null,"visible"],"-Attributs ist ",["code",null,"false"],". Die ",["code",null,"show"],"-Methode ändert diesen Zustand auf ",["code",null,"true"],". "],"\n",["p",null,"Wie schon erwähnt können wir diese Logik testen, indem wir eine neue Instanz der Komponentenklasse erzeugen, die Methode aufrufen und anschließend prüfen, ob sich der Zustand des ",["code",null,"visible"],"-Attributs auf ",["code",null,"true"]," geändert hat:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," AlertComponent ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'./alert.component'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token function"},"describe"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'AlertComponent'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token function"},"it"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'should change the visible state to true'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," alertComponent ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"new"]," ",["span",{"class":"token class-name"},"AlertComponent"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"alertComponent",["span",{"class":"token punctuation"},"."],"visible",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toEqual"],["span",{"class":"token punctuation"},"("],["span",{"class":"token boolean"},"false"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    alertComponent",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"show"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"alertComponent",["span",{"class":"token punctuation"},"."],"visible",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toEqual"],["span",{"class":"token punctuation"},"("],["span",{"class":"token boolean"},"true"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["h2",{"id":"rendering-von-komponenten-testen"},"Rendering von Komponenten testen"],"\n",["p",null,"Das reine Logiktesten reicht jedoch nicht aus. Man möchte natürlich auch das generierte HTML einer Komponente prüfen. Dazu stellt uns StencilJS die Funktion ",["code",null,"newSpecPage"]," zur Verfügung, mit der man eine Browser-Seite simulieren kann. Das hat den Vorteil, dass keine Browser Installation zum Ausführen der Unit Tests benötigt wird."],"\n",["p",null,"Um das Rendering unserer Alert-Komponente zu testen, muss zunächst eine neue Seite mit der ",["code",null,"newSpecPage"],"-Funktion erzeugt werden. Die Funktion erwartet ein Objekt vom Typ ",["code",null,"NewSpecPageOptions"]," als Parameter. In diesem Objekt müssen wir zwei Eigenschaften setzen. Zum einen die ",["code",null,"html"],"-Eigenschaft, die das eigentliche HTML der Seite festlegt. Zum anderen das ",["code",null,"components"],"-Feld, mit der dann StencilJS weiß, wie die im HTML enthaltenen Tags gerendert werden müssen. Die ",["code",null,"newSpacPage"],"-Funktion liefert uns eine in einem Promise verpackte ",["code",null,"SpecPage"],"-Instanz zurück. Das Promise können wir elegant mit dem async/await-Mechanismus auflösen. Mit dem ",["code",null,"root"],"-Attribut des Seitenobjekts und der von Jest bereitgestellten Methode ",["code",null,"toEqualHtml"],", können wir einen HTML vergleich durchführen:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," AlertComponent ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'./alert.component'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," newSpecPage ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core/testing'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token function"},"describe"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'AlertComponent'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token function"},"it"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'should render the alert'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," page ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"newSpecPage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n      components",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token punctuation"},"["],"AlertComponent",["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},","],"\n      html",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"'<cb-alert />'"],["span",{"class":"token punctuation"},","],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"page",["span",{"class":"token punctuation"},"."],"root",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toEqualHtml"],["span",{"class":"token punctuation"},"("],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"\n      <cb-alert class=\"alert\">\n        Unit Testing StencilJS\n        <span class=\"close-btn\">&times;</span>\n      </cb-alert>\n    "],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"Verwendet eine Komponente Shadow DOM, dann simuliert das StencilJS mit dem ",["code",null,"mock:shadow-root"],"-Element im Komponenten-Body. Dies muss dann im HTML-Vergleich berücksichtigt werden:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"page",["span",{"class":"token punctuation"},"."],"root",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toEqualHtml"],["span",{"class":"token punctuation"},"("],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"\n  <cb-alert class=\"alert\">\n    <mock:shadow-root>\n      Unit Testing StencilJS\n      <span class=\"close-btn\">&times;</span>\n    </mock:shadow-root>\n  </cb-alert>\n"],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"Alternativ kann man den Support für Shadow DOM mit dem ",["code",null,"supportsShadowDom"],"-Attribut in den ",["code",null,"NewSpecPageOptions"]," deaktivieren."],"\n",["p",null,"Möchte man nicht das ganze HTML vergleichen, dann kann man auch gezielt Elemente auslesen und prüfen. Über das ",["code",null,"root"],"-Attribut der ",["code",null,"SpecPage"]," gelangen wir an das Root-HTML-Element des von uns spezifizierten HTML-Inhalts (in unserem Fall ",["code",null,"cb-alert"],"). Damit können wir mit den bekannten Methoden, wie ",["code",null,"querySelector"]," oder ",["code",null,"querySelectorAll"],", auf die darunter liegenden Elemente zugreifen und Checks ausführen."],"\n",["p",null,"Um Auswirkungen durch das Ändern von Properties oder das Ausführen von Methoden zu testen, brauchen wir Zugriff auf die Komponenteninstanz. Diese bekommen wir über die Eigenschaft ",["code",null,"rootInstance"]," des Seitenobjekts. Mit der Instanz kann dann z.B. eine Methode ausgelöst werden, die den Zustand unserer Komponente verändert. Die Änderung des Zustands wird leider nicht automatisch erkannt und dementsprechend wird der HTML-Inhalt nicht neu generiert. Dies muss noch mit der ",["code",null,"waitForChanges"],"-Methode manuell durchgeführt werden:"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," AlertComponent ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'./alert.component'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," newSpecPage ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core/testing'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token function"},"describe"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'AlertComponent'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token function"},"it"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'should make the alert visible'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," page ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"newSpecPage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n      components",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token punctuation"},"["],"AlertComponent",["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},","],"\n      html",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"'<cb-alert />'"],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token keyword"},"const"]," alertElement ",["span",{"class":"token operator"},"="]," page",["span",{"class":"token punctuation"},"."],"root",["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"alertElement",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],"not",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toHaveClass"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'visible'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token keyword"},"const"]," alertComponent",["span",{"class":"token punctuation"},":"]," AlertComponent ",["span",{"class":"token operator"},"="]," page",["span",{"class":"token punctuation"},"."],"rootInstance",["span",{"class":"token punctuation"},";"],"\n    alertComponent",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"show"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token keyword"},"await"]," page",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"waitForChanges"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"alertElement",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toHaveClass"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'visible'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["h2",{"id":"mocking"},"Mocking"],"\n",["p",null,"Komponenten können eine gewisse Komplexität aufweisen. Sie können zum Beispiel komplizierte Berechnungen durchführen oder entfernte Datenendpunkte aufrufen. Dazu werden oft externe Bibliotheken oder interne Browser APIs verwendet. Diese Funktionalitäten möchte man nicht unbedingt testen, da man davon ausgeht, dass diese bereits getestet wurden und somit einwandfrei funktionieren. Solche Funktionalitäten können gemockt werden. Dazu verwendet StencilJS die von Jest zur Verfügung stehenden Mechanismen."],"\n",["p",null,"Gehen wir davon aus, dass unsere Alert-Komponente ihre anzuzeigende Nachricht von einem Server bekommt und dabei die vom Browser zur Verfügung stehende ",["code",null,"fetch"],"-API verwendet: "],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," Component",["span",{"class":"token punctuation"},","]," ComponentInterface",["span",{"class":"token punctuation"},","]," h",["span",{"class":"token punctuation"},","]," Host",["span",{"class":"token punctuation"},","]," State ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core'"],["span",{"class":"token punctuation"},";"],"\n\n@",["span",{"class":"token function"},"Component"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n  tag",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"'cb-alert'"],["span",{"class":"token punctuation"},","],"\n  styleUrl",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"'./alert.component.css'"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],"\n",["span",{"class":"token keyword"},"export"]," ",["span",{"class":"token keyword"},"class"]," ",["span",{"class":"token class-name"},"AlertComponent"]," ",["span",{"class":"token keyword"},"implements"]," ",["span",{"class":"token class-name"},"ComponentInterface"]," ",["span",{"class":"token punctuation"},"{"],"\n  @",["span",{"class":"token function"},"State"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token keyword"},"public"]," visible",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token builtin"},"boolean"]," ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token boolean"},"false"],["span",{"class":"token punctuation"},";"],"\n  @",["span",{"class":"token function"},"State"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token keyword"},"public"]," message",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token builtin"},"string"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token keyword"},"public"]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token function"},"componentWillLoad"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token builtin"},"Promise"],["span",{"class":"token operator"},"<"],["span",{"class":"token keyword"},"void"],["span",{"class":"token operator"},">"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"this"],["span",{"class":"token punctuation"},"."],"message ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"fetch"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'https://cbinzer.de/blog/unit-testing-stenciljs'"],["span",{"class":"token punctuation"},")"],"\n      ",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"then"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token parameter"},"response"],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," response",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"json"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n\n  ",["span",{"class":"token keyword"},"public"]," ",["span",{"class":"token function"},"render"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"return"]," ",["span",{"class":"token punctuation"},"("],"\n      ",["span",{"class":"token operator"},"<"],"Host ",["span",{"class":"token keyword"},"class"],["span",{"class":"token operator"},"="],["span",{"class":"token punctuation"},"{"],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"alert "],["span",{"class":"token interpolation"},["span",{"class":"token interpolation-punctuation punctuation"},"${"],["span",{"class":"token keyword"},"this"],["span",{"class":"token punctuation"},"."],"visible ",["span",{"class":"token operator"},"?"]," ",["span",{"class":"token string"},"'visible'"]," ",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"''"],["span",{"class":"token interpolation-punctuation punctuation"},"}"]],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},"}"],["span",{"class":"token operator"},">"],"\n        ",["span",{"class":"token punctuation"},"{"],["span",{"class":"token keyword"},"this"],["span",{"class":"token punctuation"},"."],"message",["span",{"class":"token punctuation"},"}"],"\n        ",["span",{"class":"token operator"},"<"],"span ",["span",{"class":"token keyword"},"class"],["span",{"class":"token operator"},"="],["span",{"class":"token string"},"\"close-btn\""],["span",{"class":"token operator"},">"],["span",{"class":"token operator"},"&"],"times",["span",{"class":"token punctuation"},";"],["span",{"class":"token operator"},"<"],["span",{"class":"token operator"},"/"],"span",["span",{"class":"token operator"},">"],"\n      ",["span",{"class":"token operator"},"<"],["span",{"class":"token operator"},"/"],"Host",["span",{"class":"token operator"},">"],"\n    ",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n\n  ",["span",{"class":"token keyword"},"public"]," ",["span",{"class":"token function"},"show"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"this"],["span",{"class":"token punctuation"},"."],"visible ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token boolean"},"true"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],"\n",["span",{"class":"token punctuation"},"}"]]],"\n  "],"\n  ",["p",null,"Mit der ",["code",null,"fn"],"-Methode von Jest, können wir relativ einfach die ",["code",null,"fetch"],"-Funktion mit einer Mock-Implementierung überschreiben. Zusätzlich überschreiben wir auch noch die ",["code",null,"json"],"-Methode des ",["code",null,"fetch"],"-Results, die uns unsere eigentliche Nachricht zurückliefert. Da das Verhalten der ",["code",null,"fetch"],"-API in jedem Test-Case gleich sein soll, erfolgt das Mocken in ",["code",null,"beforeAll"],":"],"\n\n  ",["highlight-code",null,"\n    ",["pre",{"class":"language-typescript"},["code",{"class":"language-typescript"},["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," AlertComponent ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'./alert.component'"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token keyword"},"import"]," ",["span",{"class":"token punctuation"},"{"]," newSpecPage ",["span",{"class":"token punctuation"},"}"]," ",["span",{"class":"token keyword"},"from"]," ",["span",{"class":"token string"},"'@stencil/core/testing'"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token keyword"},"declare"]," ",["span",{"class":"token keyword"},"var"]," fetch",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token builtin"},"Function"],["span",{"class":"token punctuation"},";"],"\n\n",["span",{"class":"token function"},"describe"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'AlertComponent'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n  ",["span",{"class":"token function"},"beforeAll"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    fetch ",["span",{"class":"token operator"},"="]," jest",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"fn"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"],"\n      ",["span",{"class":"token builtin"},"Promise"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"resolve"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n        ok",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token boolean"},"true"],["span",{"class":"token punctuation"},","],"\n        json",["span",{"class":"token punctuation"},":"]," jest",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"fn"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token builtin"},"Promise"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"resolve"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'Unit Testing StencilJS'"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},","],"\n      ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],"\n    ",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token function"},"it"],["span",{"class":"token punctuation"},"("],["span",{"class":"token string"},"'should render the alert'"],["span",{"class":"token punctuation"},","]," ",["span",{"class":"token keyword"},"async"]," ",["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    ",["span",{"class":"token keyword"},"const"]," page ",["span",{"class":"token operator"},"="]," ",["span",{"class":"token keyword"},"await"]," ",["span",{"class":"token function"},"newSpecPage"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"{"],"\n      components",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token punctuation"},"["],"AlertComponent",["span",{"class":"token punctuation"},"]"],["span",{"class":"token punctuation"},","],"\n      html",["span",{"class":"token punctuation"},":"]," ",["span",{"class":"token string"},"'<cb-alert />'"],["span",{"class":"token punctuation"},","],"\n    ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n    ",["span",{"class":"token function"},"expect"],["span",{"class":"token punctuation"},"("],"page",["span",{"class":"token punctuation"},"."],"root",["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"toEqualHtml"],["span",{"class":"token punctuation"},"("],["span",{"class":"token template-string"},["span",{"class":"token template-punctuation string"},"`"],["span",{"class":"token string"},"\n      <cb-alert class=\"alert\">\n        Unit Testing StencilJS\n        <span class=\"close-btn\">&times;</span>\n      </cb-alert>\n    "],["span",{"class":"token template-punctuation string"},"`"]],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n\n  ",["span",{"class":"token function"},"afterAll"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"]," ",["span",{"class":"token operator"},"=>"]," ",["span",{"class":"token punctuation"},"{"],"\n    fetch",["span",{"class":"token punctuation"},"."],["span",{"class":"token function"},"mockClear"],["span",{"class":"token punctuation"},"("],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n  ",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"],"\n",["span",{"class":"token punctuation"},"}"],["span",{"class":"token punctuation"},")"],["span",{"class":"token punctuation"},";"]]],"\n  "],"\n  ",["p",null,"Mit Jest lassen sich nicht nur einzelne Funktionen mocken, sondern auch ganze Module. Um ein Modul aus dem ",["code",null,"node_modules"],"-Verzeichnis zu mocken, muss parallel zu ",["code",null,"node_modules"]," ein ",["code",null,"__mocks__"],"-Ordner angelegt werden. In diesem Ordner wird dann die Mock-Implementierung abgelegt, die Jest beim Ausführen der Tests automatisch lädt. Für eine Mock-Implementierung der Bibliothek ",["a",{"href":"https://lodash.com/","target":"_blank"},"lodash"]," muss eine Datei ",["code",null,"lodash.ts"]," im ",["code",null,"__mocks__"],"-Verzeichnis erstellt werden. Ein gescoptes Modul hingegen, muss in der Verzeichnisstruktur erstellt werden, die den Namen des Moduls mit Scope entspricht (z.B. ",["code",null,"__mocks__/@scope/module-name.ts"],"). Weitere Informationen zu diesem Thema findet ihr in der ",["a",{"href":"https://jestjs.io/docs/en/manual-mocks","target":"_blank"},"Jest-Dokumentation"],"."],"\n",["h2",{"id":"fazit"},"Fazit"],"\n",["p",null,"Für mich ist das Testing in StencilJS sehr gelungen. Das Rad wird hier nicht neu erfunden sondern man setzt auf etablierte Bibliotheken wie Jest. Dadurch fühlt man sich schnell zu Hause, besonders wenn man aus der React oder ",["a",{"href":"https://angular.io/","target":"_blank"},"Angular"]," Welt kommt. Der einzige Nachteil für mich ist, dass man sich um das Rerendering mit ",["code",null,"waitForChanges"]," selbst kümmern muss. Zwar gibt es in den ",["code",null,"NewSpecPageOptions"]," eine Einstellung ",["code",null,"autoApplyChanges"],", diese bewirkt aber nur bei Property-Änderungen ein erneutes Rendern. Bei Änderungen des internen States einer Komponente muss das Rendern selbst getriggert werden. Außerdem sollte einem bewusst sein, dass in den Unit Tests der Browser nur simuliert wird. Dementsprechend stehen einem nicht alle Funktionen zur Verfügung. Dafür bietet uns StencilJS aber Support für e2e-Tests, auf die ich in einem weiteren Blog Post eingehen werde. Die in diesem Artikel gezeigten Beispiele findet ihr auf ",["a",{"href":"https://github.com/cbinzer/blog-post-unit-testing-stenciljs","target":"_blank"},"GitHub"],"."]]}